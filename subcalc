#!/usr/bin/env python3
import argparse
import sys
import ipaddress
try:
    import readline  # This enables arrow keys, history, and line editing
except ImportError:
    # readline is not available on all platforms (like Windows without additional packages)
    pass
from vlsm import run_vlsm_tool
from flsm import run_flsm_tool
from notation import run_conversion_tool
from iputility import run_ip_validation_tool, run_ip_in_network_tool, run_ip_range_tool
from supernet import run_supernet_tool
from utils.format import print_table
from utils.network import display_network_summary as get_network_summary
from constants import VERSION

def display_network_summary(network):
    """Display summary information about a network"""
    try:
        summary = get_network_summary(network)
        if "error" in summary:
            print(f"\nError: {summary['error']}")
            return
            
        print(f"\nNetwork Summary for {summary['network']}:")
        print(f"Network Address:     {summary['network_address']}")
        print(f"Broadcast Address:   {summary['broadcast_address']}")
        print(f"Netmask:             {summary['netmask']}")
        print(f"Prefix Length:       {summary['prefix_length']}")
        print(f"Number of Addresses: {summary['num_addresses']}")
        print(f"Usable Hosts:        {summary['usable_hosts']}")
        print(f"First Usable Host:   {summary['first_usable']}")
        print(f"Last Usable Host:    {summary['last_usable']}")
    except Exception as e:
        print(f"Error: {e}")

def main():
    """Main entry point for the subcalc tool"""
    parser = argparse.ArgumentParser(
        description="Subnet Calculator Tool - Calculate and display subnet information",
        epilog="""
Examples:
  ./subcalc --network 192.168.0.0/24                    # Display network summary
  ./subcalc --network 192.168.0.0/24 --flsm 16          # Create 16 equal-sized subnets
  ./subcalc --network 192.168.0.0/24 --flsm /28         # Create subnets with prefix /28
  ./subcalc --network 192.168.0.0/24 --vlsm 20 40 50    # Create subnets with specified host capacities
  ./subcalc --flsm                                      # Run FLSM in interactive mode
  ./subcalc --vlsm                                      # Run VLSM in interactive mode
  ./subcalc --convert /24                               # Convert between CIDR, subnet mask, and wildcard mask
  ./subcalc --convert 255.255.255.0                     # Convert between notations using subnet mask
  ./subcalc --convert                                   # Run conversion tool in interactive mode
  ./subcalc --validate 192.168.1.5                      # Validate an IP address and display information
  ./subcalc --check-ip 192.168.1.5 192.168.1.0/24       # Check if an IP address is in a network
  ./subcalc --range 192.168.1.10 192.168.1.20           # Analyze an IP address range
  ./subcalc --supernet 192.168.1.0/24 192.168.2.0/24    # Find optimal summary routes for multiple subnets
  ./subcalc --supernet                                  # Run supernetting tool in interactive mode
        """,
        formatter_class=argparse.RawDescriptionHelpFormatter,  # This preserves formatting in the epilog
        prefix_chars='-'  # Explicitly set to avoid Windows issues with / being interpreted as a flag
    )
    
    # Base network argument
    parser.add_argument(
        "--network",
        help="Base network in CIDR notation (e.g., 192.168.0.0/24)"
    )
    
    # Version
    parser.add_argument(
        "--version", "-v",
        action="version",
        version=f"SubnetCalculator v{VERSION}",
        help="Show program version and exit"
    )
    
    parser.add_argument(
        "--vlsm", 
        nargs='*', 
        type=int, 
        help="Run Variable Length Subnet Mask calculator with specified host requirements (e.g., --vlsm 20 40 80)"
    )
    
    parser.add_argument(
        "--flsm", 
        nargs='?', 
        const='interactive', 
        help="Run Fixed Length Subnet Mask calculator with number of subnets (e.g., --flsm 4) or target prefix length (e.g., --flsm /28)"
    )
    
    parser.add_argument(
        "--convert",
        nargs='?',
        const='interactive',
        help="Convert between CIDR, subnet, and wildcard masks (e.g., --convert /24 or --convert 255.255.255.0)"
    )
    
    # IP Address Utility arguments
    parser.add_argument(
        "--validate",
        nargs='?',
        const='interactive',
        help="Validate an IP address and show its properties (e.g., --validate 192.168.1.1)"
    )
    
    parser.add_argument(
        "--check-ip",
        nargs='*',
        help="Check if an IP address is in a network (e.g., --check-ip 192.168.1.5 192.168.1.0/24)"
    )
    
    parser.add_argument(
        "--range",
        nargs='*',
        help="Analyze an IP address range (e.g., --range 192.168.1.10 192.168.1.20)"
    )
    
    parser.add_argument(
        "--supernet",
        nargs='*',
        help="Find optimal summary routes for multiple subnets (e.g., --supernet 192.168.1.0/24 192.168.2.0/24)"
    )
    
    args = parser.parse_args()
    
    # IP Validation tool
    if args.validate:
        if args.validate == 'interactive':
            run_ip_validation_tool()
        else:
            run_ip_validation_tool(args.validate)
        return
    
    # IP in Network checker
    if args.check_ip is not None:
        if len(args.check_ip) == 0:
            run_ip_in_network_tool()
        elif len(args.check_ip) == 1:
            run_ip_in_network_tool(ip_address=args.check_ip[0])
        else:
            run_ip_in_network_tool(ip_address=args.check_ip[0], network=args.check_ip[1])
        return
    
    # IP Range analyzer
    if args.range is not None:
        if len(args.range) == 0:
            run_ip_range_tool()
        elif len(args.range) == 1:
            run_ip_range_tool(args.range[0])
        else:
            run_ip_range_tool(args.range[0], args.range[1])
        return
    
    # Conversion mode
    if args.convert:
        if args.convert == 'interactive':
            run_conversion_tool()
        else:
            run_conversion_tool(args.convert)
        return
    
    # Supernetting mode
    if args.supernet is not None:
        if len(args.supernet) == 0:
            run_supernet_tool()
        else:
            run_supernet_tool(args.supernet)
        return
    
    # Network summary only
    if args.network and args.vlsm is None and args.flsm is None:
        display_network_summary(args.network)
        return
        
    # VLSM mode
    if args.vlsm is not None:
        # Convert empty list to None for interactive mode
        hosts = args.vlsm if args.vlsm else None
        run_vlsm_tool(args.network, hosts)
        return
            
    # FLSM mode    
    if args.flsm is not None:
        # Convert 'interactive' or empty string to None for interactive mode
        subnet_input = None if args.flsm == 'interactive' else args.flsm
        run_flsm_tool(args.network, subnet_input)
        return
    
    # No recognized arguments provided
    parser.print_help()
    print("\nError: Please specify at least one option")
    sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nOperation cancelled by user.")
        sys.exit(0) 